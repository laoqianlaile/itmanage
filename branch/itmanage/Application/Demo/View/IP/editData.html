<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>IP地址修改</title>

    <!--[if lte IE 8]>
    <script type="text/javascript" src="__PUBLICOLD__/vendor/ie8/es5-shim.min.js"></script>
    <![endif]-->

    <link href="__PUBLICOLD__/vendor/bootstrap-table/bootstrap/css/bootstrap.min.css" rel="stylesheet" >
    <link href="__PUBLICOLD__/adminframework/css/font-awesome.css?v=4.4.0" rel="stylesheet">
    <link href="__PUBLICOLD__/adminframework/css/plugins/chosen/chosen.css" rel="stylesheet">
    <link href="__PUBLICOLD__/adminframework/css/plugins/switchery/switchery.css" rel="stylesheet">
    <link href="__PUBLICOLD__/vendor/bootstrap-table/bootstrap-table/src/bootstrap-table.css" rel="stylesheet" >
    <link href="__PUBLICOLD__/adminframework/css/animate.css" rel="stylesheet">
    <link href="__PUBLICOLD__/adminframework/css/style.css?v=4.0.0" rel="stylesheet">
    <link rel="stylesheet" href="__PUBLICOLD__/vendor/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css">

    <script src="__PUBLICOLD__/vendor/bootstrap-table/jquery.min.js"></script>
    <script src="__PUBLICOLD__/vendor/bootstrap-table/bootstrap/js/bootstrap.min.js"></script>
    <script src="__PUBLICOLD__/vendor/My97DatePicker/WdatePicker.js"></script>
    <script src="__PUBLICOLD__/adminframework/js/plugins/chosen/chosen.jquery.js"></script>
    <script src="__PUBLICOLD__/adminframework/js/plugins/chosen/chosen.order.jquery.js"></script>
    <script src="__PUBLICOLD__/vendor/chosen-ajax-addition/chosen.ajaxaddition.jquery.js"></script>

    <script src="__PUBLICOLD__/adminframework/js/plugins/prettyfile/bootstrap-prettyfile.js"></script>
    <script src="__PUBLICOLD__/adminframework/js/plugins/switchery/switchery.js"></script>
    <script src="__PUBLICOLD__/vendor/bootstrap-table/bootstrap-table/src/bootstrap-table.js"></script>
    <script src="__PUBLICOLD__/vendor/bootstrap-table/bootstrap-table/src/locale/bootstrap-table-zh-CN.js"></script>
    <script type="text/javascript" src="__PUBLICOLD__/vendor/ztree/js/jquery.ztree.core.js"></script>
    <script src="__PUBLICOLD__/adminframework/js/plugins/validate/jquery.validate.min.js"></script>

    <!--[if lt IE 9]>
    <script src="__PUBLICOLD__/vendor/ie8/html5shiv.js"></script>
    <script src="__PUBLICOLD__/vendor/ie8/respond.min.js"></script>
    <![endif]-->

     
    <style>
        .table{max-width: none;}
        .pull-left{width:100%;}
        #atpbiztoolbar{width:100%;}
        #dic_name{width: 20%;float: left;margin-right: 5px;}
        .name{font-weight:bold; margin-top:20px; margin-bottom:40px; float:left;border-left:#18a689 8px solid; padding-left: 15px;}
        /*#search{width: 70px;border: 1px #18a689 solid;height: 27px;background-color: #18a689;line-height: 24px;color: #fff;margin-top: 15px;margin-left: 15px;}*/
        /*.chosen-choices{height:80px !important;}*/
    </style>
</head>

<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="ibox float-e-margins">
        <form id="atpform" role="form"　class="form-inline">
            <div class="ibox-content" style="padding:5%;padding-top:1%;">
                <div style="margin-top:20px;width:100%;">
                    <p class="name" style="text-align: left;font-size: 20px;width:100%;">新增IP地址</p>
                </div>
                <div class="row row-lg" style="margin-top:20px;width:100%;">
                    <div class="form-group form-inline">
                        <div class="col-sm-6 form-inline" style="width:50%;">
                            <label class="control-lable" style="width:15%;margin-right:2%">起始 IP</label>
                            <input  id="ip_start" name="ip_start" type="text" class="form-control" value="{$ipInfo.ip_start}" readonly="true">
                            <font color="orangered">*</font>
                        </div>
                        <div class="col-sm-6 form-inline" style="width:50%;">
                            <label class="control-lable  " style="width:15%;margin-right:2%">结束 IP</label>
                            <input  id="ip_end" name="ip_end" type="text" class="form-control" value="{$ipInfo.ip_end}" readonly="true">
                            <font color="orangered">*</font>
                        </div>
                    </div>
                </div>
                <div class="row row-lg" style="margin-top:20px;width:100%;">
                    <div class="form-group form-inline">
                        <div class="col-sm-6 form-inline" style="width:50%;">
                            <label class="control-lable" style="width:15%;margin-right:2%">子网掩码</label>
                            <input  id="ip_mask" name="ip_mask" type="text" class="form-control" value="{$ipInfo.ip_mask}" required="true">
                            <font color="orangered">*</font>
                        </div>
                        <div class="col-sm-6 form-inline" style="width:50%;">
                            <label class="control-lable  " style="width:15%;margin-right:2%;">网&emsp;关</label>
                            <input  id="ip_gateway" name="ip_gateway" type="text" class="form-control" value="{$ipInfo.ip_gateway}" required="true">
                            <font color="orangered">*</font>
                        </div>
                    </div>
                </div>
                <div class="row row-lg" style="margin-top:20px;width:100%;">
                    <div class="form-group form-inline">
                        <div class="col-sm-6 form-inline" style="width:50%;">
                            <label class="control-lable" style="width:15%;margin-right:2%">Vlan号</label>
                            <input  id="ip_vlan_no" name="ip_vlan_no" type="text" class="form-control" value="{$ipInfo.ip_vlan_no}">
                        </div>
                        <div class="col-sm-6 form-inline" style="width:50%;">
                            <label class="control-lable  " style="width:15%;margin-right:2%;">密&emsp;级</label>
                            <select id="ip_secret_level" name="ip_secret_level" class="chosen-select2" style="width: 41%;" >
                                <option value="">请选择</option>
                                <foreach name="ipsecretlevel" item="val">
                                    <option value="{$val.d_sortno}" <if condition="$val['d_sortno'] == $ipInfo['ip_secret_level']">selected</if>>{$val.d_dictname}</option>
                                    <!--<if condition="$val['d_sortno'] == $ipInfo['ip_secret_level']">selected</if>-->
                                    <!--<?php if($val['d_sortno'] == $ipInfo['ip_secret_level']){ echo "selected";}else{ echo $ipInfo['ip_secret_level'];}?>-->
                                </foreach>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row row-lg" style="margin-top:20px;width:100%;">
                    <div class="form-group form-inline">
                        <div class="col-sm-6 form-inline" style="width:50%;">
                            <div class="col-sm-7 form-inline" style="width:61%;padding:0;">
                                <div style="width:100%;padding:0;margin-bottom:20px;">
                                    <label class="control-lable" style="width:27%;margin-right:2%">地&emsp;区</label>
                                    <select name="ip_area" id="ip_area" class="form-control" style="width:66%;">
                                        <option value="">请选择</option>
                                        <foreach name="iparea" item="val">
                                            <option value="{$val.d_atpid}">{$val.d_dictname}</option>
                                        </foreach>
                                    </select>
                                </div>
                                <div style="width:100%;padding:0;">
                                    <label class="control-lable" style="width:27%;margin-right:2%">楼&emsp;宇</label>
                                    <select name="ip_building" id="ip_building" class="form-control" style="width:66%;">
                                        <option value="">请选择</option>
                                        <foreach name="ds_chuliperson" item="vo">
                                            <option value="{$vo.yw_account}">{$vo.yw_name}</option>
                                        </foreach>
                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-5 form-inline" style="width:38%;padding:0;">
                                <select id="select_region" name="select_region" data-placeholder=" " class="chosen-select_long" multiple >
                                    <option value="" checked></option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6 form-inline" style="width:50%;">
                            <label class="control-lable  " style="width:15%;margin-right:2%;">部&emsp;门</label>
                            <select id="select_dept" name="select_dept" style="" class="chosen-select_longs" multiple >
                                <option value="" checked></option>
                            </select>
                            <button class="btn btn-primary" type="button" id="choosedept" style="margin-left:2%;margin-bottom: 0px;">选择</button>
                        </div>
                    </div>
                </div>
                <div class="row row-lg" style="margin-top: 25px;">
                    <div class="col-sm-12 form-inline" style="width:100%;">
                            <label class="control-lable" style="width:7%;margin-right:1%;">用&emsp;途</label>
                            <textarea class="form-control" rows="5" id="ip_purpose" name="ip_purpose" style="width:70%;">{$ipInfo.ip_purpose}</textarea>
                            <input type="hidden" id="ip_atpid" name="ip_atpid" value="{$ipInfo.ip_atpid}" />
                            <input type="hidden" id="ip_areainfo" name="ip_areainfo" value="{$ipInfo.ip_areainfo}" />
                            <input type="hidden" id="ip_deptinfo" name="ip_deptinfo" value="{$ipInfo.ip_deptinfo}" />
                    </div>
                </div>
                <div class="row row-lg" style="margin-top: 25px;">
                    <div class="form-group">
                        <label class="control-lable  col-sm-4"></label>
                        <button class="btn btn-primary" type="button" id="submit">保存</button>
                        <label class="control-lable" style="width:10%">&nbsp;</label>
                        <button class="btn btn-primary " type="button" id="cancel">取消</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div id="sys_dept" role="dialog" class="modal fade "></div>
    <div class="modal fade" id="loading" role="dialog" data-backdrop='static'>
        <div class="modal-dialog" style="z-index: 99999999;" >
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myModalLabel">处理中</h4>
                </div>
                <div class="modal-body">
                    <img src="__PUBLICOLD__/img/loading/loading8.gif" style='display: block;margin: 0 auto;z-index:3000;'>
                    <div id="loadingText" style="text-align: center"></div>
                </div>
            </div>
        </div>
    </div>
    <!--<div id="warning" class="alert alert-success">-->
        <!--<a href="#"class="close" data-dismiss="alert">&times;</a>-->
        <!--该值已存在！-->
    <!--</div>-->
</div>
<script>
    CHOSEN_DEFAULT_TEXT ="";
</script>
<script>


    $(function () {
        $(".chosen-select_long").chosen({disable_search_threshold: 10, search_contains: false,width:'100%',height:'88px !imprtant'});
        $(".chosen-select_longs").chosen({disable_search_threshold: 10, search_contains: false,width:'60%',height:'88px !imprtant'});
       //写入地区
        var areaInfo = '<?php echo  $ipInfo["ip_areainfo"];?>';
//        var areaInfo = $('#ip_areainfo').val();
        if(areaInfo != ''){
            areaInfo = eval(areaInfo);
            for(var i = 0;i<areaInfo.length;i++){
                $('#select_region').append('<option value="'+ areaInfo[i]['d_atpid']+'" selected  >'+areaInfo[i]['d_dictname']+'</option>');
            }
            $('#select_region').trigger("chosen:updated");
        }

        //写入部门
        var deptInfo = '<?php echo  $ipInfo["ip_deptinfo"];?>';
        if(deptInfo != ''){
            deptInfo = eval(deptInfo);
//            deptInfo = JSON.parse(deptInfo);
            for(var i = 0;i<deptInfo.length;i++){
                $('#select_dept').append('<option value="'+ deptInfo[i]['id']+'" selected  >'+deptInfo[i]['name']+'</option>');
            }
            $('#select_dept').trigger("chosen:updated");
        }

        //删除
//        $(".chosen-select_long option").remove();
        $('#ip_building').on('change',function(){
            var building = $("#ip_building option:selected").val();
            var buildinghtml = $("#ip_building option:selected").html();
            var tmp = $('.chosen-choices').html();
            if(tmp.indexOf(buildinghtml)<0){
                $('#select_region').append('<option value="'+building+'" selected  >'+buildinghtml+'</option>');
                $('#select_region').trigger("chosen:updated");
            }
        })

        $(".chosen-select2").chosen({disable_search_threshold: 10, search_contains: true});

        $('#cancel').click(function(){
            history.go(-1);
        })

        $('#choosedept').click(function(){
            $("#sys_dept").load('__CONTROLLER__/getDeptTree', function() {
                $("#sys_dept").modal({backdrop: false});
            });
        })
    });

    $('#ip_area').on('change',function() {
        var area     = $("#ip_area option:selected").val();
        var areaname = $("#ip_area option:selected").html();
        $.post('__CONTROLLER__/getbuilding', {area: area}, function (rep) {
            var typearr = eval("(" + rep + ")");
            if (typearr.length > 0) {
                $("#ip_building").children().remove();
                var item = "";
//                item += "<option value='' selected='selected'></option>";
                item += "<option value='"+area+"' selected='selected'>"+areaname+"全部</option>";
                for (var i = 0; i < typearr.length; i++) {
                    item += "<option value='" + typearr[i]['d_atpid'] + "'>" + typearr[i]['d_dictname'] + "</option>";
                }
                $("#ip_building").append(item);
            }
            else
                $("#ip_building").children().remove();
        });
    });

    $('#submit').on('click',function (){
        var ip_mask    = $('#ip_mask');
        var ip_gateway = $('#ip_gateway');
        var res = checkSub([ip_mask,ip_gateway]); //验证IP地址数据格式
        if(!res) return false;
        var ip_mask         = ip_mask.val();
        var ip_gateway      = ip_gateway.val();
        var ip_vlan_no      = $('#ip_vlan_no');
        if(ip_vlan_no.val() != ''){
            var reg = /^[1-9]\d*$/;
            var res = reg.test(ip_vlan_no.val());
            if(!res){
                ip_vlan_no.parent().addClass('has-error');
                return false;
            }else{
                ip_vlan_no.parent().removeClass('has-error');
                ip_vlan_no.parent().addClass('has-success');
            }
        }
        var ip_secret_level = $('#ip_secret_level').val();
        var select_region   = $('#select_region').val();
        var select_dept     = $('#select_dept').val();
        var ip_purpose      = $('#ip_purpose').val();
        $.ajax({
                type:'post',
                url:'__CONTROLLER__/IPcheckEdit',
                data:{
                    ip_atpid:$('#ip_atpid').val(),
                    ip_mask:ip_mask,
                    ip_gateway:ip_gateway,
                    ip_vlan_no:ip_vlan_no.val(),
                    ip_secret_level:ip_secret_level,
                    ip_area:select_region,
                    ip_depart:select_dept,
                    ip_purpose:ip_purpose,
                },
                beforeSend:function(){
                    $("#loadingText").html("正在处理请稍后");
                    $('#loading').modal('show');
                },
                success:function(res){
                    if(res.code != 0){
                        alert(res.message);
                    }else{
                        alert('修改数据成功！');
                        location.href='__CONTROLLER__/index';
                    }
                },
                complete:function(){
                    $('#loading').modal('hide');
                },
                dataType:'json'
    });
    })

    function checkSub(para){
        var reg  = /^(10|192)\.([1-9]{1}\d?)\.(\d|1\d?\d?|2(\d|([0-4]\d|5[0-5]))|[1-9]\d)\.(\d|1\d?\d?|2(\d|([0-4]\d|5[0-5]))|[1-9]\d)$/;
        var reg1 = /^255\.255\.(\d|1\d?\d?|2(\d|([0-4]\d|5[0-5]))|[1-9]\d)\.(\d|1\d?\d?|2(\d|([0-4]\d|5[0-5]))|[1-9]\d)$/;
        var regs = '';
        var err  = 0;
        for(var i = 0;i<para.length;i++){
            if(para[i].val() == ''){
                para[i].parent().addClass('has-error');
                err = 1;
            }else{
                if(para[i].attr('name') == 'ip_mask'){
                    regs = reg1;
                }else{
                    regs = reg;
                }
                var re = regs.test(para[i].val());
                if(!re){
                    para[i].parent().addClass('has-error');
                    err = 1;
                }else{
                    para[i].parent().removeClass('has-error');
                    para[i].parent().addClass('has-success');
                }
            }
        }
        if(err == 1){
            return false;
        }else{
            return true;
        }
    }

    function formatIP(ip){
//        var ip_num = '';
        var num    = ip.split('.');
        var ip_num = parseInt(num[0]*256*256*256)+parseInt(num[1]*256*256)+parseInt(num[2]*256)+parseInt(num[3]);
//        for(var i = 0;i<num.length;i++){
//            var len = num[i].length;
//            if(len == 1){
//                ip_num += '00'+ num[i];
//            }else if(len == 2){
//                ip_num += '0'+ num[i];
//            }else{
//                ip_num += num[i];
//            }
//        }
        return ip_num;
    }
</script>
</body>

</html>




