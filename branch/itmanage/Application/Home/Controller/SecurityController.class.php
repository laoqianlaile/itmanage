<?phpnamespace Home\Controller;use Think\Controller;class SecurityController extends BaseController {        public function index(){        addLog("","用户访问日志","","访问Security页面","成功");        $arr = ['资产责任单位','使用责任单位','设备类型(安全产品)','密级','地区','厂家','型号','使用状态(安全产品)'];        $arrDic = D('Dic')->getDicValueByName($arr);        $factory = D('Dic')->getFactoryList('安全产品');        $this->assign('zcDept',$arrDic['资产责任单位']);        $this->assign('syDept',$arrDic['使用责任单位']);        $this->assign('sbType', $arrDic['设备类型(安全产品)']);        $this->assign('miJi', $arrDic['密级']);        $this->assign('diQu', $arrDic['地区']);        $this->assign('changJia', $factory);       // $this->assign('changJia', $arrDic['厂家']);        $this->assign('xingHao', $arrDic['型号']);        $this->assign('suoShuWangLuo',$arrDic['所属网络']);        $this->assign('status',$arrDic['使用状态(安全产品)']);        $this->display();    }        /**    * 安全产品添加或修改    */    public function add(){        $id = trim(I('get.sp_atpid'));        if(!empty($id)){            $model = M('security_products');            $model->execute("alter session set NLS_DATE_FORMAT='YYYY-MM-DD'");            $data = $model->field('sp_atpid,sp_config,sp_mac,sp_tel,sp_farend,sp_modifyuser,sp_createtime,sp_useman,sp_status,sp_cert,sp_assetusedept,sp_assetdutydept,sp_modifytime,sp_startusetime,sp_dutydept,sp_publish,sp_certnum,sp_atpstatus,sp_ip,sp_area,sp_host,sp_useage,sp_swport,sp_submac,sp_logserver,sp_dutyman,sp_description,sp_modelnumber,sp_distalend,sp_usedept,sp_liezhuangnum,sp_roomno,sp_purchasetime,sp_secretlevel,sp_position,sp_net,sp_swip,sp_producedate,sp_name,sp_grqnum,sp_expirydate,sp_anecode,sp_gateway,sp_buytime,sp_createuser,sp_type,sp_mask,sp_belongfloor,sp_remark,sp_receivetime,sp_sn,sp_devicecode,sp_ios,sp_factory,sp_subip,sp_receivedept')->where("sp_atpid='%s'", $id)->find();            session('list',$data);            //使用人            $userId = $data['sp_useman'];            if (!empty($userId)) {                $userName = D('org')->getViewPerson($userId);                $userMan['name'] = $userName['realusername'] . '(' . $userName['username'] . ')--' . $userName['orgname'];                $userMan['username'] = $userName['username'];                $userDept = $this->removeStr($userName['orgfullname']); //去掉字符串            } else {                $userMan = [];                $userDept = '';            }            $this->assign('userman', $userMan);            $this->assign('userDept', $userDept);            //责任人            $dutuserId = $data['sp_dutyman'];            if (!empty($dutuserId)) {                $dutuserName = D('org')->getViewPerson($dutuserId);                $dutuser['name'] = $dutuserName['realusername'] . '(' . $dutuserName['username'] . ')--' . $dutuserName['orgname'];                $dutuser['username'] = $dutuserName['username'];                $dutyDept = $this->removeStr($dutuserName['orgfullname']); //去掉字符串            } else {                $dutuser = [];                $dutyDept = '';            }            $this->assign('dutuser', $dutuser);            $this->assign('dutyDept', $dutyDept);        }        $arr = ['资产责任单位','使用责任单位','设备类型(安全产品)','密级','地区','厂家','型号','所属网络','使用状态(安全产品)'];        $factory = D('Dic')->getFactoryList('安全产品');        $arrDic = D('Dic')->getDicValueByName($arr);        $this->assign('zcDept',$arrDic['资产责任单位']);        $this->assign('syDept',$arrDic['使用责任单位']);        $this->assign('sbType', $arrDic['设备类型(安全产品)']);        $this->assign('miJi', $arrDic['密级']);        $this->assign('diQu', $arrDic['地区']);        //$this->assign('changJia', $arrDic['厂家']);       $this->assign('changJia', $factory);        $this->assign('xingHao', $arrDic['型号']);        $this->assign('status', $arrDic['使用状态(安全产品)']);        $this->assign('suoShuWangLuo',$arrDic['所属网络']);     //  print_r($data);die;        $this->assign('data', $data);        addLog('','用户访问日志','',"访问Security添加、编辑页面",'成功');        $this->display();    }        /**     * 数据添加、修改     */    public function addData(){        $data = I('post.');        $type = $data['sp_type'];        $id = trim($data['sp_atpid']);        // 这里根据实际需求,进行字段的过滤        if($type == '线路干扰器'){            if(!empty($data['xsp_name']) ){$data['sp_name'] = trim($data['xsp_name']);}            if(!empty($data['xsp_farend']) ){$data['sp_farend'] = trim($data['xsp_farend']);}            if(!empty($data['xsp_swip']) ){$data['sp_swip'] = trim($data['xsp_swip']);}            if(!empty($data['xsp_position']) ){$data['sp_position'] = trim($data['xsp_position']);}            if(!empty($data['xsp_swport']) ){$data['sp_swport'] = trim($data['xsp_swport']);}            if(!empty($data['xsp_distalend']) ){$data['sp_distalend'] = trim($data['xsp_distalend']);}            if(!empty($data['xsp_grqnum']) ){$data['sp_grqnum'] = trim($data['xsp_grqnum']);}        }        if($type == '视频干扰器'){            if(!empty($data['jsp_position']) ){$data['sp_position'] = trim($data['jsp_position']);}            if(!empty($data['jsp_tel']) ){$data['sp_tel'] = trim($data['jsp_tel']);}            if(!empty($data['jsp_receivetime']) ){$data['sp_receivetime'] = trim($data['jsp_receivetime']);}            if(!empty($data['jsp_description']) ){$data['sp_description'] = trim($data['jsp_description']);}        }        if($type == '密码机' ){            if(!empty($data['msp_buytime']) ){$data['sp_buytime'] = trim($data['msp_buytime']);}            if(!empty($data['msp_expirydate']) ){$data['sp_expirydate'] = trim($data['msp_expirydate']);}            if(!empty($data['msp_useage']) ){$data['sp_useage'] = trim($data['msp_useage']);}            if(!empty($data['msp_net']) ){$data['sp_net'] = trim($data['msp_net']);}            if(!empty($data['msp_receivetime']) ){$data['sp_receivetime'] = trim($data['msp_receivetime']);}            if(!empty($data['msp_submac']) ){$data['sp_submac'] = trim($data['msp_submac']);}            if(!empty($data['msp_mac']) ){$data['sp_mac'] = trim($data['msp_mac']);}            if(!empty($data['msp_subip']) ){$data['sp_subip'] = trim($data['msp_subip']);}            if(!empty($data['msp_ip']) ){$data['sp_ip'] = trim($data['msp_ip']);}            if(!empty($data['msp_liezhuangnum']) ){$data['sp_liezhuangnum'] = trim($data['msp_liezhuangnum']);}            if(!empty($data['msp_receivedept']) ){$data['sp_receivedept'] = trim($data['msp_receivedept']);}        }        if($type == '漏洞扫描' || $type == '入侵检测' ){            if(!empty($data['dsp_expirydate']) ){$data['sp_expirydate'] = trim($data['dsp_expirydate']);}            if(!empty($data['dsp_net']) ){$data['sp_net'] = trim($data['dsp_net']);}            if(!empty($data['dsp_receivetime']) ){$data['sp_receivetime'] = trim($data['dsp_receivetime']);}            if(!empty($data['dsp_producedate']) ){$data['sp_producedate'] = trim($data['dsp_producedate']);}            if(!empty($data['dsp_ip']) ){$data['sp_ip'] = trim($data['dsp_ip']);}            if(!empty($data['dsp_subip']) ){$data['sp_subip'] = trim($data['dsp_subip']);}            if(!empty($data['dsp_mac']) ){$data['sp_mac'] = trim($data['dsp_mac']);}            if(!empty($data['dsp_submac']) ){$data['sp_submac'] = trim($data['dsp_submac']);}            if(!empty($data['dsp_useage']) ){$data['sp_useage'] = trim($data['dsp_useage']);}            if(!empty($data['dsp_buytime']) ){$data['sp_buytime'] = trim($data['dsp_buytime']);}            if(!empty($data['dsp_tel']) ){$data['sp_tel'] = trim($data['dsp_tel']);}            if(!empty($data['dsp_publish']) ){$data['sp_publish'] = trim($data['dsp_publish']);}            if(!empty($data['dsp_cert']) ){$data['sp_cert'] = trim($data['dsp_cert']);}            if(!empty($data['dsp_certnum']) ){$data['sp_certnum'] = trim($data['dsp_certnum']);}            if(!empty($data['dsp_swport']) ){$data['sp_swport'] = trim($data['dsp_swport']);}            if(!empty($data['dsp_receivedept']) ){$data['sp_receivedept'] = trim($data['dsp_receivedept']);}        }        if($type == '网络准入' || $type == '流量控制器' || $type == '网闸' ){            if(!empty($data['zsp_net']) ){$data['sp_net'] = trim($data['zsp_net']);}            if(!empty($data['zsp_swport']) ){$data['sp_swport'] = trim($data['zsp_swport']);}            if(!empty($data['zsp_useage']) ){$data['sp_useage'] = trim($data['zsp_useage']);}            if(!empty($data['zsp_sn']) ){$data['sp_sn'] = trim($data['zsp_sn']);}            if(!empty($data['zsp_mask']) ){$data['sp_mask'] = trim($data['zsp_mask']);}            if(!empty($data['zsp_swip']) ){$data['sp_swip'] = trim($data['zsp_swip']);}            if(!empty($data['zsp_host']) ){$data['sp_host'] = trim($data['zsp_host']);}            if(!empty($data['zsp_logserver']) ){$data['sp_logserver'] = trim($data['zsp_logserver']);}            if(!empty($data['zsp_ios']) ){$data['sp_ios'] = trim($data['zsp_ios']);}            if(!empty($data['zsp_config']) ){$data['sp_config'] = trim($data['zsp_config']);}            if(!empty($data['zsp_ip']) ){$data['sp_ip'] = trim($data['zsp_ip']);}        }        //责任人id        $data['sp_dutydept'] = D('org')->getDeptId($data['sp_dutyman']);        //使用人id        $data['sp_usedept'] = D('org')->getDeptId($data['sp_useman']);        $data['sp_area'] = $this->getDicById($data['sp_area'], 'dic_name'); //地区        $data['sp_belongfloor'] = $this->getDicLouYuById($data['sp_belongfloor'], 'dic_name'); //楼宇        $data['sp_factory'] = $this->getDicFactort($data['sp_factory'], 'dic_name'); //厂家        $data['sp_modelnumber'] = $this->getDicXingHaoById($data['sp_modelnumber'], 'dic_name'); //型号        //领用单位转成中文入库        $receivedept  = $data['sp_receivedept'];        if(!empty($receivedept)){            $dept= D('org')->getDeptName($receivedept);            $data['sp_receivedept'] =   $this -> removeStr($dept);//去掉字符串        }        //验证ip        if (!empty($data['sp_ip'])) {            if ($this->checkAddress($data['sp_ip'], 'IP') === false) exit(makeStandResult(-1, 'ip地址有误'));        }        //默认网关有误        if (!empty($data['sp_gateway'])) {            if ($this->checkAddress($data['sp_gateway'], 'IP') === false) exit(makeStandResult(-1, '默认网关有误'));        }        //子IP地址        if (!empty($data['sp_subip'])) {            $sp_subips  = str_replace(',',';',$data['sp_subip']);            $sp_subips = explode(';',$sp_subips);            foreach($sp_subips as $ip){                if ($this->checkAddress($ip, 'IP') === false) exit(makeStandResult(-1, '子IP地址有误'));            }        }        //验证mac        if (!empty($data['sp_mac'])) {            if ($this->checkAddress($data['sp_mac'], 'MAC') === false) exit(makeStandResult(-1, 'mac地址有误'));        }        //子mac地址有误        if (!empty($data['sp_submac'])) {            $sp_submacs  = str_replace(',',';',$data['sp_submac']);            $sp_submacs = explode(';',$sp_submacs);            foreach($sp_submacs as $ip) {                if ($this->checkAddress($ip, 'MAC') === false) exit(makeStandResult(-1, '子mac地址有误'));            }        }        $sp_subips  = str_replace(',',';',$data['sp_subip']);        $subips = explode(';',$sp_subips);        $ipIlop = [$data['sp_ip']];        $ip = array_merge($subips,$ipIlop);        $ip = array_filter($ip);        $ips = array_count_values($ip);        foreach($ips as $key =>$val){            if($val > 1){                exit(makeStandResult(-1, '页面中填写的'.$key.'重复，请修改后提交'));            }        }        $model = M('security_products');        $modelSub = M('subelement');        $model->execute("alter session set NLS_DATE_FORMAT='YYYY-MM-DD HH24:MI:SS'");        $time = date('Y-m-d H:i:s', time());        $user = session('user_id');        // 下面代码请跟据实际需求进行修改：记录创建时间、创建人，完善日志内容        if(empty($id)){            $model->startTrans();            try {                //验证地址是否已被使用                $Fx = D('ip')->addIpCs($ip, $data['sp_status']);                if ($Fx != 'success') {                    exit(makeStandResult(-1, $Fx . 'IP地址已被使用'));                }                $data['sp_atpid'] = makeGuid();                //若子IP不为空，拆分子IP将相应信息写入subelement表中                if (!empty($data['sp_subip'])) {                    $subIP = str_replace(';', ',', $data['sp_subip']);                    $subIP = explode(',', $subIP);                    foreach ($subIP as $v) {                        $list['sub_content'] = $v;                        $list['sub_type'] = $data['sp_type'];                        $list['sub_pid'] = $data['sp_atpid'];                        $list['sub_num'] = ip2long($v);                        $list['sub_field'] = 'sp_subip';                        $modelSub->add($list);                    }                }                //若子mac不为空，拆分子mac将相应信息写入subelement表中                if (!empty($data['sp_submac'])) {                    $submac = str_replace(';', ',', $data['sp_submac']);                    $submac = explode(',', $submac);                    foreach ($submac as $mac) {                        $arr['sub_content'] = $mac;                        $arr['sub_type'] = $data['sp_type'];                        $arr['sub_pid'] = $data['sp_atpid'];                        $arr['sub_field'] = 'sp_submac';                        $modelSub->add($arr);                    }                }                $data['sp_createtime'] = $time;                $data['sp_createuser'] = $user;                $data = $model->create($data);                $res = $model->add($data);                $model->commit();                if(!empty($res)) {                    addLog('security_products', '对象添加日志', '添加主键为' . $data['sp_atpid'] . '成功', '成功', $data['sp_atpid']);                    exit(makeStandResult(1, '添加成功'));                }            } catch (\Exception $e) {                $model->rollback();                addLog('security_products', '对象添加日志', '添加主键为'.$data['sp_atpid']. '失败', '失败',$data['sp_atpid']);                exit(makeStandResult(-1, '添加失败'));            }        }else{            $model->startTrans();            try {                $spList = $model->where("sp_atpid = '%s'",$id)->find();                $subipsUp  = str_replace(',',';',$spList['sp_subip']);                $subipsUp = explode(';',$subipsUp);                $ipIlopUp = [$spList['sp_ip']];                $ipUp = array_merge($subipsUp,$ipIlopUp);                $ipUp = array_filter($ipUp);                //验证ip是否已被使用                $Fx = D('ip')->saveIpCs($ip,$ipUp,$data['sp_status']);                if($Fx != 'success'){                    exit(makeStandResult(-1, $Fx.'IP地址已被使用'));                }                $modelSub->where("sub_pid = '%s'",$data['sp_atpid'])->delete();                //若子IP不为空，拆分子IP将相应信息写入subelement表中                if(!empty($data['sp_subip'])){                    $subIP  = str_replace(';',',',$data['sp_subip']);                    $subIP = explode(',',$subIP);                    foreach($subIP as $v){                        $list['sub_content'] = $v;                        $list['sub_type'] = $data['sp_type'];                        $list['sub_pid']  = $data['sp_atpid'];                        $list['sub_num'] = ip2long($v);                        $list['sub_field'] = 'sp_subip';                        $modelSub->add($list);                    }                }                //若子mac不为空，拆分子mac将相应信息写入subelement表中                if(!empty($data['sp_submac'])){                    $submac  = str_replace(';',',',$data['sp_submac']);                    $submac = explode(',',$submac);                    foreach($submac as $mac){                        $arr['sub_content'] = $mac;                        $arr['sub_type'] = $data['sp_type'];                        $arr['sub_pid']  = $data['sp_atpid'];                        $arr['sub_field'] = 'sp_submac';                        $modelSub->add($arr);                    }                }                $data = $model->create($data);                $lists = session('list');                $content = LogContent($data,$lists);                $data['sp_pmodifytime'] = $time;                $data['sp_pmodifyuser'] = $user;                $res = $model->where("sp_atpid='%s'", $id)->save($data);                $model->commit();                if(!empty($res)) {                    addLog('security_products', '对象修改日志', $content, '成功', $id);                }                exit(makeStandResult(1, '修改成功'));            } catch (\Exception $e) {                $model->rollback();                addLog('security_products', '对象修改日志', '主键为'.$id. '失败', '失败',$id);                exit(makeStandResult(-1, '修改失败'));            }        }    }        /**     * 获取安全产品数据     */    public function getData($isExport = false){        if($isExport){            $queryParam = I('post.');            $filedStr = 'sp_devicecode,sp_anecode,sp_type,sp_ip,sp_mask,sp_gateway,sp_mac,sp_subip,sp_submac,sp_name,sp_useage,sp_factory,sp_modelnumber,sp_sn,sp_status,sp_secretlevel,sp_assetdutydept,sp_assetusedept,sp_purchasetime,sp_startusetime,sp_area,sp_belongfloor,sp_roomno,sp_dutyman,sp_dutydept,sp_useman,sp_usedept,sp_net,sp_remark,sp_swip,sp_swport,sp_farend,sp_distalend,sp_grqnum,sp_position,sp_tel,sp_description,sp_buytime,sp_receivetime,sp_expirydate,sp_producedate,sp_liezhuangnum,sp_cert,sp_certnum,sp_publish,sp_host,sp_logserver,sp_ios,sp_config,sp_receivedept';        }else{            $filedStr = 'sp_devicecode,sp_anecode,sp_type,sp_ip,sp_mask,sp_gateway,sp_mac,sp_subip,sp_submac,sp_name,sp_useage,sp_factory,sp_modelnumber,sp_sn,sp_status,sp_secretlevel,sp_assetdutydept,sp_assetusedept,sp_purchasetime,sp_startusetime,sp_area,sp_belongfloor,sp_roomno,sp_dutyman,sp_dutydept,sp_useman,sp_usedept,sp_net,sp_remark,sp_swip,sp_swport,sp_farend,sp_distalend,sp_grqnum,sp_position,sp_tel,sp_description,sp_buytime,sp_receivetime,sp_expirydate,sp_producedate,sp_liezhuangnum,sp_cert,sp_certnum,sp_publish,sp_host,sp_logserver,sp_ios,sp_config, sp_atpid,sp_receivedept';            $queryParam = I('put.');        }        // 过滤方法这里统一为trim，请根据实际需求更改        $where = [];        $where['sp_atpstatus'] = ['exp', 'IS NULL'];        $spDevicecode = trim($queryParam['sp_devicecode']);        if(!empty($spDevicecode)) $where['sp_devicecode'] = ['like', "%$spDevicecode%"];                $spAnecode = trim($queryParam['sp_anecode']);        if(!empty($spAnecode)) $where['sp_anecode'] = ['like', "%$spAnecode%"];                $spType = trim($queryParam['sp_type']);        if(!empty($spType)) $where['sp_type'] = ['like', "%$spType%"];                $spIp = trim($queryParam['sp_ip']);        if(!empty($spIp)) $where['sp_ip'] = ['like', "%$spIp%"];                $spMask = trim($queryParam['sp_mask']);        if(!empty($spMask)) $where['sp_mask'] = ['like', "%$spMask%"];                $spGateway = trim($queryParam['sp_gateway']);        if(!empty($spGateway)) $where['sp_gateway'] = ['like', "%$spGateway%"];                $spMac = trim($queryParam['sp_mac']);        if(!empty($spMac)) $where['sp_mac'] = ['like', "%$spMac%"];                $spSubip = trim($queryParam['sp_subip']);        if(!empty($spSubip)) $where['sp_subip'] = ['like', "%$spSubip%"];                $spSubmac = trim($queryParam['sp_submac']);        if(!empty($spSubmac)) $where['sp_submac'] = ['like', "%$spSubmac%"];                $spName = trim($queryParam['sp_name']);        if(!empty($spName)) $where['sp_name'] = ['like', "%$spName%"];                $spUseage = trim($queryParam['sp_useage']);        if(!empty($spUseage)) $where['sp_useage'] = ['like', "%$spUseage%"];                $spFactory = trim($queryParam['sp_factory']);        $spFactory = D('dic')->getDicFactoryName($spFactory);        if(!empty($spFactory)) $where['sp_factory'] = ['like', "%$spFactory%"];        $spModelnumber = trim($queryParam['sp_modelnumber']);        $spModelnumber = D('dic')->getDicXingHaoName($spModelnumber);        if(!empty($spModelnumber)) $where['sp_modelnumber'] = ['like', "%$spModelnumber%"];                $spStatus = trim($queryParam['sp_status']);        if(!empty($spStatus)) $where['sp_status'] = ['like', "%$spStatus%"];                $spSecretlevel = trim($queryParam['sp_secretlevel']);        if(!empty($spSecretlevel)) $where['sp_secretlevel'] = ['like', "%$spSecretlevel%"];                $spAssetdutydept = trim($queryParam['sp_assetdutydept']);        if(!empty($spAssetdutydept)) $where['sp_assetdutydept'] = ['like', "%$spAssetdutydept%"];                $spAssetusedept = trim($queryParam['sp_assetusedept']);        if(!empty($spAssetusedept)) $where['sp_assetusedept'] = ['like', "%$spAssetusedept%"];                        $spArea = trim($queryParam['sp_area']);        $spArea = D('dic')->getDicAreaName($spArea);        if(!empty($spArea)) $where['sp_area'] = ['like', "%$spArea%"];                $spBelongfloor = trim($queryParam['sp_belongfloor']);        $spBelongfloor = D('dic')->getDicLouYuName($spBelongfloor);        if(!empty($spBelongfloor)) $where['sp_belongfloor'] = ['like', "%$spBelongfloor%"];                $spRoomno = trim($queryParam['sp_roomno']);        if(!empty($spRoomno)) $where['sp_roomno'] = ['like', "%$spRoomno%"];                $spDutyman = trim($queryParam['sp_dutyman']);        if(!empty($spDutyman)) $where['sp_dutyman'] = ['like', "%$spDutyman%"];                $spDutydept = trim($queryParam['sp_dutydept']);        if(!empty($spDutydept)) $where['sp_dutydept'] = ['like', "%$spDutydept%"];                $spUseman = trim($queryParam['sp_useman']);        if(!empty($spUseman)) $where['sp_useman'] = ['like', "%$spUseman%"];                $spUsedept = trim($queryParam['sp_usedept']);        if(!empty($spUsedept)) $where['sp_usedept'] = ['like', "%$spUsedept%"];                        $spRemark = trim($queryParam['sp_remark']);        if(!empty($spRemark)) $where['sp_remark'] = ['like', "%$spRemark%"];                $spSwip = trim($queryParam['sp_swip']);        if(!empty($spSwip)) $where['sp_swip'] = ['like', "%$spSwip%"];                $spSwport = trim($queryParam['sp_swport']);        if(!empty($spSwport)) $where['sp_swport'] = ['like', "%$spSwport%"];                $spFarend = trim($queryParam['sp_farend']);        if(!empty($spFarend)) $where['sp_farend'] = ['like', "%$spFarend%"];                $spDistalend = trim($queryParam['sp_distalend']);        if(!empty($spDistalend)) $where['sp_distalend'] = ['like', "%$spDistalend%"];                $spGrqnum = trim($queryParam['sp_grqnum']);        if(!empty($spGrqnum)) $where['sp_grqnum'] = ['like', "%$spGrqnum%"];                        $spReceivetime = trim($queryParam['sp_receivetime']);        if(!empty($spReceivetime)) $where['sp_receivetime'] = ['like', "%$spReceivetime%"];        $model = M('security_products');        $model->execute("alter session set NLS_DATE_FORMAT='YYYY-MM-DD'");        $count = $model->where($where)->count();        $obj = $model->field($filedStr)            ->where($where)            ->order("$queryParam[sort] $queryParam[sortOrder]");        if($isExport){            $data = $obj->select();            foreach ($data as $k => &$v) {                //翻译字典//                $v['app_status'] = !empty($v['app_status'])?$this ->getDicById($v['app_status'],'dic_name'):'-';//使用状态//                $v['app_secret'] = !empty($v['app_secret'])?$this ->getDicById($v['app_secret'],'dic_name'):'-';//密级                //责任人                if(!empty($v['sp_dutyman'])){                    $userName = D('org')->getViewPerson($v['sp_dutyman']);//                    $v['app_dutyman'] = $userName['realusername'] . '(' . $userName['username'] . ')';                    $v['sp_dutyman'] = $userName['realusername'];                    //责任人部门                    $v['sp_dutydept'] = $this -> removeStr($userName['orgfullname']);//去掉字符串                }else{                    $v['sp_dutyman'] = '-';                    $v['sp_dutydept'] = '-';                }                //使用人                if(!empty($v['sp_useman'])){                    $userName = D('org')->getViewPerson($v['sp_useman']);//                    $v['app_dutyman'] = $userName['realusername'] . '(' . $userName['username'] . ')';                    $v['sp_useman'] = $userName['realusername'];                    //使用人部门                    $v['sp_usedept'] = $this -> removeStr($userName['orgfullname']);//去掉字符串                }else{                    $v['sp_useman'] = '-';                    $v['sp_usedept'] = '-';                }            }            $header = ['设备编码','部标编码','设备类型','IP地址','子网掩码','网关','MAC地址','子IP地址','子MAC地址','名称','用途','厂家','型号','出厂编号','状态','密级','资产责任单位','使用责任单位','采购日期','启用日期','地区','楼宇','房间号','责任人','责任部门','使用人','使用部门','所属网络','备注','交换机地址','交换机端口','最远端(线路干扰器)','次远端(线路干扰器)','路数(线路干扰器)','部署地点(线路干扰器、视频干扰器)','联系方式','描述','购入时间(漏洞扫描、入侵检测)','领用时间','有效期','出厂时间(漏洞扫描)','列装号(密码机)','证书名称','证书编号','颁发机构','管理主机地址','日志服务器地址','IOS版本','配置信息(网闸)','领用部门'];            if($count <= 0){              exit(makeStandResult(-1, '没有要导出的数据'));            } else if( $count > 1000){                csvExport($header, $data, true);            }else{                excelExport($header, $data, true);            }        }else{            $data = $obj->limit($queryParam['offset'], $queryParam['limit'])                ->select();            foreach ($data as $k => &$v) {                //翻译字典//                $v['app_status'] = !empty($v['app_status'])?$this ->getDicById($v['app_status'],'dic_name'):'-';//使用状态//                $v['app_secret'] = !empty($v['app_secret'])?$this ->getDicById($v['app_secret'],'dic_name'):'-';//密级                //责任人                if(!empty($v['sp_dutyman'])){                    $userName = D('org')->getViewPerson($v['sp_dutyman']);//                    $v['app_dutyman'] = $userName['realusername'] . '(' . $userName['username'] . ')';                    $v['sp_dutyman'] = $userName['realusername'];                    //责任人部门                    $v['sp_dutydept'] = $this -> removeStr($userName['orgfullname']);//去掉字符串                }else{                    $v['sp_dutyman'] = '-';                    $v['sp_dutydept'] = '-';                }                //使用人                if(!empty($v['sp_useman'])){                    $userName = D('org')->getViewPerson($v['sp_useman']);//                    $v['app_dutyman'] = $userName['realusername'] . '(' . $userName['username'] . ')';                    $v['sp_useman'] = $userName['realusername'];                    //使用人部门                    $v['sp_usedept'] = $this -> removeStr($userName['orgfullname']);//去掉字符串                }else{                    $v['sp_useman'] = '-';                    $v['sp_usedept'] = '-';                }                $rlxCount = M('it_relationx')->where("rlx_zyid = '%s' and rlx_atpstatus is null",$v['sp_atpid'])->count();                $data[$k]['spCount'] = $rlxCount;            }            exit(json_encode(array( 'total' => $count,'rows' => $data)));        }    }        /**     * 删除数据     */    public function delData(){        $ids = trim(I('post.sp_atpid'));       // print_r($ids);die;        if(empty($ids)) exit(makeStandResult(-1,'参数缺少'));        $time = date('Y-m-d H:i:s', time());        $user = session('user_id');        $arr = explode(',', $ids);        $model = M('security_products');        $where['sp_atpid'] = ['in',$arr];        $ipList = $model->where($where)->select();        //删除ipp        $ip = removeArrKey($ipList,'sp_ip');        $subip = removeArrKey($ipList,'sp_subip');        $iloip = removeArrKey($ipList,'sp_iloip');        $ips = array_merge($ip,$iloip);        foreach($subip as $val){            $subipSon  = str_replace(',',';',$val);            $subipSon = explode(';',$subipSon);            $ips = array_merge($ips,$subipSon);        }        $ips =array_unique(array_filter($ips));        D('ip')->DelIpCs($ips);        $model->execute("alter session set NLS_DATE_FORMAT='YYYY-MM-DD HH24:MI:SS'");        $model->startTrans();        try {            foreach ($arr as $k => $id) {                $data['sp_modifytime'] = $time;                $data['sp_modifyuser'] = $user;                $data['sp_atpstatus']  = 'DEL';                $res =  $model->where("sp_atpid='%s'", $id)->save($data);                $list['rlx_atpstatus'] = 'DEL';                M('it_relationx')->where("rlx_zyid = '%s'",$id)->save($list);                if($res){                    addLog('security', '对象删除日志',  "删除主键为".$id."成功", '成功');                    D('relation')->delRelation($id, 'security_products');                }            }            $model->commit();            exit(makeStandResult(1, '删除成功'));        } catch (\Exception $e) {            $model->rollback();            addLog('security', '对象删除日志',  "删除主键为".$id."失败", '失败');            exit(makeStandResult(-1, '删除失败'));        }    }}